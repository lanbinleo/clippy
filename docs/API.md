# Clippy API 文档

## 概述
Clippy 是一个多端同步剪贴板工具，通过 WebSocket 实现手机和电脑之间的实时文本同步。

## 服务端信息
- **地址**: `localhost:8948`
- **WebSocket端点**: `ws://localhost:8948/ws`
- **HTTP端点**: `http://localhost:8948/shutdown` (关闭服务器)
- **协议**: WebSocket (JSON消息格式)

---

## HTTP API

### 关闭服务器 (shutdown)

**端点**: `POST http://localhost:8948/shutdown`

**用途**: 优雅地关闭Clippy服务器

**请求方法**: POST / GET

**请求示例**:
```bash
curl -X POST http://localhost:8948/shutdown
```

**响应**:
```
Server shutting down...
```

**说明**:
- 服务器收到请求后会在500ms内优雅关闭
- 所有WebSocket连接会被正常断开
- 桌面客户端可使用此端点实现"重启服务器"功能

---

## WebSocket 连接

### 连接地址
```
ws://localhost:8948/ws
```

### 连接方式
直接使用 WebSocket 客户端连接，无需鉴权。

---

## 消息格式

所有消息使用 **JSON 格式**，通过 WebSocket 发送和接收。

### 基础消息结构
```json
{
  "type": "消息类型",
  "content": "消息内容（可选）",
  "timestamp": 1704038400 // Unix时间戳（可选）
}
```

---

## 消息类型

### 1. 更新文本 (update)

**用途**: 手机端发送语音输入的文字，同步到所有连接的客户端。

**发送方**: 手机端

**接收方**: 所有连接的客户端（包括电脑端）

**消息示例**:
```json
{
  "type": "update",
  "content": "这是通过语音输入的文字内容"
}
```

**字段说明**:
- `type`: 固定为 `"update"`
- `content`: 要同步的文本内容，字符串类型

**行为**:
- 服务器收到此消息后，会广播给所有连接的客户端
- 电脑端收到后，如果 `content` 非空，会弹出显示窗口
- 如果 `content` 为空字符串，电脑端会隐藏显示窗口

---

### 2. 清空文本 (clear)

**用途**: 清空共享的文本内容，隐藏电脑端的显示窗口。

**发送方**: 手机端或电脑端

**接收方**: 所有连接的客户端

**消息示例**:
```json
{
  "type": "clear"
}
```

**字段说明**:
- `type`: 固定为 `"clear"`
- `content`: 可选，通常为空

**行为**:
- 服务器收到此消息后，会广播给所有连接的客户端
- 电脑端收到后，会隐藏显示窗口
- 手机端收到后，可以清空输入框

---

### 3. 连接确认 (connected)

**用途**: 服务器向新连接的客户端发送欢迎消息。

**发送方**: 服务器

**接收方**: 新连接的客户端

**消息示例**:
```json
{
  "type": "connected",
  "content": "Connected to Clippy server"
}
```

**字段说明**:
- `type`: 固定为 `"connected"`
- `content`: 欢迎信息

---

## 使用流程

### 手机端流程

1. **连接服务器**
   ```javascript
   const ws = new WebSocket('ws://YOUR_PC_IP:8948/ws');
   ```

2. **发送文本更新**
   ```javascript
   ws.send(JSON.stringify({
     type: "update",
     content: "语音输入的文字"
   }));
   ```

3. **发送清空命令**
   ```javascript
   ws.send(JSON.stringify({
     type: "clear"
   }));
   ```

4. **接收消息**（监听其他客户端的操作）
   ```javascript
   ws.onmessage = (event) => {
     const msg = JSON.parse(event.data);
     if (msg.type === "clear") {
       // 清空本地输入框
     }
   };
   ```

### 电脑端流程

1. **连接服务器** (由程序自动完成)
2. **接收消息**:
   - 收到 `update` 且 `content` 非空 → 弹出窗口显示文本
   - 收到 `update` 且 `content` 为空 → 隐藏窗口
   - 收到 `clear` → 隐藏窗口
3. **用户点击"复制"** → 文本复制到剪贴板，窗口不关闭
4. **用户点击"清空"** → 发送 `clear` 消息，窗口隐藏

---

## 错误处理

### 连接失败
如果无法连接到 `ws://localhost:8948/ws`，请检查：
- 服务器是否已启动
- 端口 8948 是否被占用
- 防火墙是否阻止连接

### 消息格式错误
如果发送的消息不是有效的 JSON 格式，服务器会忽略该消息。

---

## 注意事项

1. **无鉴权**: 当前版本无密码保护，仅限本地网络使用
2. **无持久化**: 文本内容不会保存到磁盘，重启后清空
3. **广播模式**: 所有消息会广播给所有连接的客户端
4. **content 为空的特殊含义**: 当 `update` 消息的 `content` 为空字符串时，等同于 `clear` 行为

---

## 示例场景

### 场景 1: 手机语音输入同步
```
手机端 → 服务器 → 电脑端
{"type": "update", "content": "帮我查一下明天的天气"}
电脑端收到后弹窗显示，用户点击"复制"，粘贴到浏览器搜索框
```

### 场景 2: 清空内容
```
手机端 → 服务器 → 电脑端
{"type": "clear"}
电脑端收到后隐藏窗口
```

### 场景 3: 电脑端清空
```
用户点击电脑端"清空"按钮 → 电脑端 → 服务器 → 手机端
{"type": "clear"}
手机端收到后可以清空输入框
```

---

## 版本信息
- **版本**: v1.0.0
- **最后更新**: 2025-12-30
